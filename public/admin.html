<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mkenya OTADrive - Advanced Local OTA Server</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 8px; font-size: 2.5em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .subtitle { font-size: 1.1em; opacity: 0.9; }

    /* Tab Navigation */
    .tab-navigation { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden; }
    .tab-buttons { display: flex; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .tab-btn { flex: 1; padding: 16px 24px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: 600; color: #6c757d; transition: all 0.3s ease; position: relative; }
    .tab-btn:hover { background: #e9ecef; color: #495057; }
    .tab-btn.active { color: #3498db; background: white; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #3498db; }

    .tab-content { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 30px; margin-top: 20px; min-height: 600px; }
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Form Styles */
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
    input[type="text"], input[type="password"], input[type="email"], input[type="file"], select { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; transition: all 0.3s ease; box-sizing: border-box; }
    input[type="text"]:focus, input[type="password"]:focus, input[type="email"]:focus, input[type="file"]:focus, select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }

    /* Button Styles */
    .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, #3498db, #2980b9); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 16px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
    .btn:active { transform: translateY(0); }
    .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3); }
    .btn-secondary:hover { box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4); }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
    .btn-danger:hover { box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }
    .btn-success { background: linear-gradient(135deg, #27ae60, #229954); box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
    .btn-success:hover { box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); }

    /* Card Styles */
    .card { background: #f8f9fa; padding: 24px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; transition: all 0.3s ease; }
    .card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); transform: translateY(-2px); }

    /* Grid Layouts */
    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .status-item { background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .status-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .status-item h3 { margin: 0 0 12px; color: #2c3e50; font-size: 1.1em; }
    .status-item p { margin: 0; color: #7f8c8d; font-family: 'Courier New', monospace; word-break: break-all; font-size: 14px; }

    .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .config-item { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    /* Console Styles */
    .console { background: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; padding: 20px; border-radius: 10px; height: 400px; overflow-y: auto; font-size: 14px; line-height: 1.4; }
    .console-entry { margin-bottom: 8px; padding: 4px 0; border-bottom: 1px solid #333; }
    .console-timestamp { color: #888; font-size: 12px; }
    .console-device { color: #4ec9b0; font-weight: bold; }
    .console-action { color: #dcdcaa; }
    .console-success { color: #4ec9b0; }
    .console-error { color: #f44747; }
    .console-warning { color: #ffcc00; }

    /* Alert Styles */
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; animation: slideIn 0.3s ease; }
    .alert-success { background: linear-gradient(135deg, #d4edda, #c3e6cb); color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: linear-gradient(135deg, #f8d7da, #f5c6cb); color: #721c24; border: 1px solid #f5c6cb; }
    .alert-warning { background: linear-gradient(135deg, #fff3cd, #ffeaa7); color: #856404; border: 1px solid #ffeaa7; }

    @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Loading Animation */
    .loading { text-align: center; color: #7f8c8d; padding: 40px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .tab-buttons { flex-direction: column; }
      .tab-btn { padding: 12px 16px; }
      .status-grid { grid-template-columns: 1fr; }
      .config-grid { grid-template-columns: 1fr; }
      .header { padding: 20px; }
      h1 { font-size: 2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ Mkenya OTADrive</h1>
      <p class="subtitle">Advanced Local OTA Server for ESP32/Arduino Devices</p>
    </div>

    <div class="tab-navigation">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="overview">üìä Overview</button>
        <button class="tab-btn" data-tab="firmware">üì§ Firmware</button>
        <button class="tab-btn" data-tab="groups">üë• Groups</button>
        <button class="tab-btn" data-tab="devices">üì± Devices</button>
        <button class="tab-btn" data-tab="downloads">‚¨áÔ∏è Downloads</button>
        <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
      </div>

      <div class="tab-content">
        <!-- Overview Tab -->
        <div class="tab-pane active" id="overview">
          <div class="status-grid">
            <div class="status-item">
              <h3>üìà Server Status</h3>
              <p id="serverStatus">Loading...</p>
            </div>
            <div class="status-item">
              <h3>üë• Total Groups</h3>
              <p id="totalGroups">Loading...</p>
            </div>
            <div class="status-item">
              <h3>üì± Total Devices</h3>
              <p id="totalDevices">Loading...</p>
            </div>
            <div class="status-item">
              <h3>‚úÖ Approved Devices</h3>
              <p id="approvedDevices">Loading...</p>
            </div>
          </div>

          <div class="card">
            <h3>üìä Recent Activity</h3>
            <div id="recentActivityOverview">
              <!-- Recent activities will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Firmware Tab -->
        <div class="tab-pane" id="firmware">
          <div class="card">
            <h3>üì§ Upload Firmware</h3>
            <form id="uploadForm" enctype="multipart/form-data">
              <div class="form-group">
                <label for="firmware">Firmware File (.bin)</label>
                <input type="file" id="firmware" name="firmware" accept=".bin" required>
              </div>
              <div class="form-group">
                <label for="version">Version (e.g. v1.2.3)</label>
                <input type="text" id="version" name="version" placeholder="v1.0.0" required>
              </div>
              <div class="form-group">
                <label for="group">Target Group</label>
                <select id="group" name="group_id" required>
                  <option value="">Select a group...</option>
                </select>
              </div>
              <button class="btn" type="submit">Upload Firmware</button>
            </form>
          </div>

          <div class="card">
            <h3>üìã Firmware Versions by Group</h3>
            <div id="firmwareVersions">
              <!-- Firmware versions will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Groups Tab -->
        <div class="tab-pane" id="groups">
          <div class="card">
            <h3>‚ûï Create New Group</h3>
            <div class="form-group">
              <label for="newGroupName">Group Name</label>
              <input type="text" id="newGroupName" placeholder="e.g. Production ESP32s">
            </div>
            <div class="form-group">
              <label for="newGroupDesc">Description (optional)</label>
              <input type="text" id="newGroupDesc" placeholder="Group description">
            </div>
            <button class="btn" id="createGroupBtn">Create Group</button>
          </div>

          <div class="card">
            <h3>üìã Existing Groups</h3>
            <div id="groupsList">
              <!-- Groups will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Devices Tab -->
        <div class="tab-pane" id="devices">
          <div class="card">
            <h3>‚è≥ Pending Approval</h3>
            <div style="margin-bottom: 15px;">
              <button class="btn btn-danger" id="clearPendingBtn">Clear All Pending Devices</button>
            </div>
            <div id="pendingDevices">
              <!-- Pending devices will be loaded here -->
            </div>
          </div>

          <div class="card">
            <h3>üì± All Devices</h3>
            <div id="allDevices">
              <!-- All devices will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Device Details Tab (hidden by default) -->
        <div class="tab-pane" id="deviceDetails" style="display: none;">
          <div class="card">
            <h3>üì± Device Details: <span id="deviceDetailId"></span></h3>
            <button class="btn btn-secondary" onclick="closeDeviceDetails()">‚Üê Back to Devices</button>
          </div>

          <div class="card">
            <h3>üìä Device Information</h3>
            <div id="deviceInfo">
              <!-- Device info will be loaded here -->
            </div>
          </div>

          <div class="card">
            <h3>üìã Connection History</h3>
            <div id="deviceConnectionHistory">
              <!-- Connection history will be loaded here -->
            </div>
          </div>

          <div class="card">
            <h3>‚¨áÔ∏è Firmware Downloads</h3>
            <div id="deviceFirmwareHistory">
              <!-- Firmware download history will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Downloads Tab -->
        <div class="tab-pane" id="downloads">
          <div class="card">
            <h3>‚¨áÔ∏è Firmware Downloads</h3>
            <div class="form-group">
              <label for="downloadGroup">Select Group</label>
              <select id="downloadGroup">
                <option value="">Select a group...</option>
              </select>
            </div>
            <button class="btn btn-success" id="downloadBtn">Download Firmware</button>

            <div class="form-group" style="margin-top: 20px;">
              <label><strong>API URLs for Selected Group:</strong></label>
              <div id="apiUrls" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; margin-top: 10px;">
                <div><strong>Check Firmware Version:</strong></div>
                <div id="checkUrl" style="color: #4ec9b0; margin: 5px 0; word-break: break-all;">Select a group to see URL</div>
                <div style="margin-top: 10px;"><strong>Download Firmware:</strong></div>
                <div id="downloadUrl" style="color: #4ec9b0; margin: 5px 0; word-break: break-all;">Select a group to see URL</div>
                <div style="margin-top: 10px; color: #888; font-size: 12px;">
                  <strong>Headers required:</strong><br>
                  x-device-id: [Your ESP32 Chip ID]<br>
                  x-api-key: [Group API Key shown above]
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üñ•Ô∏è Device Connection Console</h3>
            <div class="console" id="deviceConsole">
              <!-- Console entries will be added here -->
            </div>
            <button class="btn btn-secondary" id="clearConsoleBtn" style="margin-top: 10px;">Clear Console</button>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane" id="settings">
          <div class="config-grid">
            <div class="config-item">
              <h3>üîê Change Password</h3>
              <input type="email" id="userEmail" placeholder="Email" readonly style="background: #f8f9fa;">
              <input type="password" id="currentPassword" placeholder="Current password" style="margin-top: 8px;">
              <input type="password" id="newPassword" placeholder="New password" style="margin-top: 8px;">
              <button class="btn" id="changePasswordBtn" style="margin-top: 8px;">Change Password</button>
            </div>
            <div class="config-item">
              <h3>üö™ Account</h3>
              <button class="btn btn-danger" id="logoutBtn">Logout</button>
            </div>
          </div>

          <div class="card">
            <h3>‚ÑπÔ∏è API Information</h3>
            <div class="status-grid">
              <div class="status-item">
                <h3>Device Check Endpoint</h3>
                <p><code>/deviceapi/check</code></p>
              </div>
              <div class="status-item">
                <h3>Firmware Download</h3>
                <p><code>/deviceapi/firmware.bin</code></p>
              </div>
              <div class="status-item">
                <h3>Manifest</h3>
                <p><code>/deviceapi/manifest.json</code></p>
              </div>
            </div>
            <p style="margin-top: 15px; color: #7f8c8d; font-size: 0.9em;">Use API key in header <code>x-api-key</code> or as query parameter <code>api_key</code></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer style="text-align: center; margin-top: 40px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; color: white;">
      <div style="margin-bottom: 10px;">
        <strong>Innovate Kenya</strong>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Engineer:</strong> Augustine Mwendwa
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Contact:</strong> masterdeveloper254@gmail.com
      </div>
      <div>
        <strong>WhatsApp:</strong> +254704863390
      </div>
    </footer>
  </div>

  <script>
    let currentFirmware = null;
    let consoleEntries = [];

    // Tab Navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Update active tab content
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');

        // Load tab-specific data
        switch(tabName) {
          case 'overview':
            loadOverviewData();
            break;
          case 'firmware':
            loadGroups();
            loadFirmwareVersions();
            break;
          case 'groups':
            loadGroups();
            break;
          case 'devices':
            loadDevices();
            break;
          case 'downloads':
            loadGroupsForDownload();
            break;
        }
      });
    });

    async function loadStatus() {
      try {
        const r = await fetch('/api/firmware/check');
        const json = await r.json();
        currentFirmware = json;
        updateStatusDisplay(json);
      } catch (e) {
        updateStatusDisplay({ error: 'No firmware / server not ready' });
      }
    }

    async function loadOverviewData() {
      try {
        const [groupsRes, devicesRes, logsRes] = await Promise.all([
          fetch('/api/devices/groups'),
          fetch('/api/devices/devices'),
          fetch('/api/devices/logs?limit=10')
        ]);

        const groups = await groupsRes.json();
        const devices = await devicesRes.json();
        const logs = await logsRes.json();

        document.getElementById('totalGroups').textContent = groups.length;
        document.getElementById('totalDevices').textContent = devices.length;
        document.getElementById('approvedDevices').textContent = devices.filter(d => d.approved).length;

        const logsContainer = document.getElementById('recentActivityOverview');
        logsContainer.innerHTML = logs.length === 0 ? '<p>No recent activity</p>' :
          logs.map(log => `
            <div class="status-item" style="margin-bottom: 10px;">
              <p><strong>${log.deviceId}</strong> - ${log.action} <small>(${new Date(log.timestamp).toLocaleString()})</small></p>
            </div>
          `).join('');
      } catch (error) {
        console.error('Failed to load overview data:', error);
      }
    }

    function updateStatusDisplay(data) {
      const container = document.getElementById('statusContainer');
      if (data.error) {
        container.innerHTML = `
          <div class="status-item">
            <h3>Status</h3>
            <p>${data.error}</p>
          </div>
        `;
        document.getElementById('downloadBtn').classList.add('hidden');
        return;
      }

      container.innerHTML = `
        <div class="status-item">
          <h3>Version</h3>
          <p>${data.version || 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>MD5 Hash</h3>
          <p>${data.md5 || 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>File Size</h3>
          <p>${data.size ? formatBytes(data.size) : 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>Download URL</h3>
          <p>${data.url || '/deviceapi/firmware.bin'}</p>
        </div>
      `;
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      document.querySelector('.card').insertBefore(alertDiv, document.querySelector('.card').firstChild);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    // Load initial data
    loadStatus();
    loadOverviewData();

    // Initialize console
    addConsoleEntry('System initialized', 'success');
    loadUserInfo();

    // Upload form handler
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Uploading...';
      submitBtn.disabled = true;

      try {
        const res = await fetch('/api/upload', { method: 'POST', body: form });
        const data = await res.json();
        if (res.ok) {
          showAlert(`‚úÖ ${data.message}`);
          loadGroups(); // Refresh groups
          e.target.reset();
        } else {
          showAlert(`‚ùå ${data.message}`, 'error');
        }
      } catch (err) {
        showAlert(`‚ùå Upload failed: ${err.message}`, 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Download button handler
    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (currentFirmware && currentFirmware.url) {
        window.open(currentFirmware.url, '_blank');
      } else {
        showAlert('No firmware available for download', 'error');
      }
    });

    // Group management
    document.getElementById('createGroupBtn').addEventListener('click', async () => {
      const name = document.getElementById('newGroupName').value.trim();
      const description = document.getElementById('newGroupDesc').value.trim();

      if (!name) {
        showAlert('Group name is required', 'error');
        return;
      }

      try {
        const res = await fetch('/api/devices/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert('Group created successfully');
          document.getElementById('newGroupName').value = '';
          document.getElementById('newGroupDesc').value = '';
          loadGroups();
          loadDevices();
        } else {
          showAlert(`Failed to create group: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error creating group: ${error.message}`, 'error');
      }
    });

    // Load and display groups
    async function loadGroups() {
      try {
        const res = await fetch('/api/devices/groups');
        const groups = await res.json();
        const container = document.getElementById('groupsList');
        const uploadSelect = document.getElementById('group');

        // Update upload form select
        if (uploadSelect) {
          uploadSelect.innerHTML = '<option value="">Select a group...</option>';
          groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = `${group.name} (${group.apiKey.substring(0, 8)}...)`;
            uploadSelect.appendChild(option);
          });
        }

        // Display groups list
        container.innerHTML = '<h3>Existing Groups</h3>';
        if (groups.length === 0) {
          container.innerHTML += '<p>No groups created yet.</p>';
          return;
        }

        groups.forEach(group => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'status-item';
          groupDiv.innerHTML = `
            <h4>${group.name}</h4>
            <p><strong>API Key:</strong> ${group.apiKey}</p>
            <p><strong>Description:</strong> ${group.description || 'No description'}</p>
            <p><strong>Firmware:</strong> ${group.firmware ? `v${group.firmware.version} (${formatBytes(group.firmware.size)})` : 'No firmware uploaded'}</p>
            <button class="btn btn-danger" onclick="deleteGroup('${group.id}')">Delete Group</button>
          `;
          container.appendChild(groupDiv);
        });
      } catch (error) {
        console.error('Failed to load groups:', error);
      }
    }

    // Load groups for download tab
    async function loadGroupsForDownload() {
      try {
        const res = await fetch('/api/devices/groups');
        const groups = await res.json();
        const select = document.getElementById('downloadGroup');
        select.innerHTML = '<option value="">Select a group...</option>';
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load groups for download:', error);
      }
    }

    // Load firmware versions
    async function loadFirmwareVersions() {
      try {
        const res = await fetch('/api/devices/groups');
        const groups = await res.json();
        const container = document.getElementById('firmwareVersions');

        container.innerHTML = groups.length === 0 ? '<p>No groups created yet.</p>' :
          groups.map(group => `
            <div class="status-item">
              <h4>${group.name}</h4>
              <p><strong>API Key:</strong> ${group.apiKey}</p>
              <p><strong>Firmware:</strong> ${group.firmware ? `v${group.firmware.version} (${formatBytes(group.firmware.size)})` : 'No firmware uploaded'}</p>
              <p><strong>Uploaded:</strong> ${group.firmware ? new Date(group.firmware.uploadedAt).toLocaleString() : 'N/A'}</p>
            </div>
          `).join('');
      } catch (error) {
        console.error('Failed to load firmware versions:', error);
      }
    }

    // Console functions
    function addConsoleEntry(message, type = 'info', deviceId = null) {
      const consoleDiv = document.getElementById('deviceConsole');
      const entryDiv = document.createElement('div');
      entryDiv.className = 'console-entry';

      const timestamp = new Date().toLocaleTimeString();
      const devicePart = deviceId ? `<span class="console-device">${deviceId}</span> ` : '';
      const actionPart = `<span class="console-action">${message}</span>`;
      const typeClass = `console-${type}`;

      entryDiv.innerHTML = `
        <span class="console-timestamp">[${timestamp}]</span>
        ${devicePart}${actionPart}
      `;
      entryDiv.classList.add(typeClass);

      consoleDiv.appendChild(entryDiv);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;

      // Keep only last 100 entries
      while (consoleDiv.children.length > 100) {
        consoleDiv.removeChild(consoleDiv.firstChild);
      }
    }

    // Clear console
    document.getElementById('clearConsoleBtn').addEventListener('click', () => {
      document.getElementById('deviceConsole').innerHTML = '';
      addConsoleEntry('Console cleared', 'warning');
    });

    // Clear pending devices
    document.getElementById('clearPendingBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to clear all pending devices? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch('/api/devices/pending/clear', { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          showAlert(data.message);
          loadDevices();
        } else {
          showAlert(`Failed to clear pending devices: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error clearing pending devices: ${error.message}`, 'error');
      }
    });

    // Delete device
    async function deleteDevice(deviceId) {
      if (!confirm('Are you sure you want to delete this device? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`/api/devices/devices/${deviceId}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          showAlert('Device deleted successfully');
          loadDevices();
        } else {
          showAlert(`Failed to delete device: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error deleting device: ${error.message}`, 'error');
      }
    }

    // Update API URLs when group selection changes
    document.getElementById('downloadGroup').addEventListener('change', (e) => {
      const groupId = e.target.value;
      const baseUrl = window.location.origin;

      if (groupId) {
        document.getElementById('checkUrl').textContent = `${baseUrl}/deviceapi/check?device_id=[ESP32_CHIP_ID]&api_key=[GROUP_API_KEY]`;
        document.getElementById('downloadUrl').textContent = `${baseUrl}/deviceapi/firmware.bin?group_id=${groupId}&device_id=[ESP32_CHIP_ID]&api_key=[GROUP_API_KEY]`;
      } else {
        document.getElementById('checkUrl').textContent = 'Select a group to see URL';
        document.getElementById('downloadUrl').textContent = 'Select a group to see URL';
      }
    });

    // Download firmware handler
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const groupId = document.getElementById('downloadGroup').value;
      if (!groupId) {
        showAlert('Please select a group', 'error');
        return;
      }

      // Trigger download with admin flag
      window.open(`/deviceapi/firmware.bin?group_id=${groupId}&admin_download=true`, '_blank');
      addConsoleEntry(`Admin firmware download initiated for group ${groupId}`, 'success');
    });

    // Delete group
    async function deleteGroup(groupId) {
      if (!confirm('Are you sure you want to delete this group? All associated devices will be removed.')) {
        return;
      }

      try {
        const res = await fetch(`/api/devices/groups/${groupId}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          showAlert('Group deleted successfully');
          loadGroups();
          loadDevices();
        } else {
          showAlert(`Failed to delete group: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error deleting group: ${error.message}`, 'error');
      }
    }

    // Load devices
    async function loadDevices() {
      try {
        const res = await fetch('/api/devices/devices');
        const devices = await res.json();

        const pendingContainer = document.getElementById('pendingDevices');
        const allContainer = document.getElementById('allDevices');

        // Pending devices
        const pending = devices.filter(d => !d.approved && !d.blacklisted);
        pendingContainer.innerHTML = '<h3>Pending Approval</h3>';
        if (pending.length === 0) {
          pendingContainer.innerHTML += '<p>No devices waiting for approval.</p>';
        } else {
          pending.forEach(device => {
            const deviceDiv = document.createElement('div');
            deviceDiv.className = 'status-item';
            deviceDiv.innerHTML = `
              <h4>Device ID: ${device.id}</h4>
              <p><strong>First Seen:</strong> ${new Date(device.firstSeen).toLocaleString()}</p>
              <p><strong>Connection Attempts:</strong> ${device.connectionCount || 1}</p>
              <p><strong>Provided API Key:</strong> ${device.providedApiKey || 'None'}</p>
              <select id="groupSelect_${device.id}" style="margin-right: 10px;">
                <option value="">Select group...</option>
              </select>
              <button class="btn" onclick="approveDevice('${device.id}')">Approve</button>
              <button class="btn btn-danger" onclick="blacklistDevice('${device.id}')">Blacklist</button>
            `;
            pendingContainer.appendChild(deviceDiv);

            // Load groups for this device (prioritize suggested groups)
            loadGroupsForDevice(device.id, device.suggestedGroups || []);
          });
        }

        // All devices
        allContainer.innerHTML = '<h3>All Registered Devices</h3>';
        if (devices.length === 0) {
          allContainer.innerHTML += '<p>No devices registered yet.</p>';
        } else {
          devices.forEach(device => {
            const status = device.blacklisted ? 'Blacklisted' : device.approved ? 'Approved' : 'Pending';
            const statusClass = device.blacklisted ? 'danger' : device.approved ? 'success' : 'warning';

            const deviceDiv = document.createElement('div');
            deviceDiv.className = 'status-item';
            deviceDiv.style.cursor = 'pointer';
            deviceDiv.onclick = () => showDeviceDetails(device.id);
            deviceDiv.innerHTML = `
              <h4>Device ID: ${device.id}</h4>
              <p><strong>Status:</strong> <span style="color: ${statusClass === 'danger' ? 'red' : statusClass === 'success' ? 'green' : 'orange'}">${status}</span></p>
              <p><strong>Group:</strong> ${device.groupName || 'None'}</p>
              <p><strong>Last Seen:</strong> ${new Date(device.lastSeen).toLocaleString()}</p>
              <p><strong>Connection Count:</strong> ${device.connectionCount || 1}</p>
              <div style="margin-top: 10px;">
                ${device.blacklisted ?
                  `<button class="btn" onclick="unblacklistDevice('${device.id}'); event.stopPropagation();">Unblacklist</button>` :
                  `<button class="btn btn-danger" onclick="blacklistDevice('${device.id}'); event.stopPropagation();">Blacklist</button>`
                }
                <button class="btn btn-danger" onclick="deleteDevice('${device.id}'); event.stopPropagation();" style="margin-left: 10px;">Delete</button>
              </div>
            `;
            allContainer.appendChild(deviceDiv);
          });
        }
      } catch (error) {
        console.error('Failed to load devices:', error);
      }
    }

    async function loadGroupsForDevice(deviceId, suggestedGroups = []) {
      try {
        const res = await fetch('/api/devices/groups');
        const allGroups = await res.json();
        const select = document.getElementById(`groupSelect_${deviceId}`);

        // Clear existing options
        select.innerHTML = '<option value="">Select group...</option>';

        // Add suggested groups first (those matching the device's API key)
        if (suggestedGroups.length > 0) {
          const suggestedOptGroup = document.createElement('optgroup');
          suggestedOptGroup.label = 'Suggested Groups (API Key Match)';
          suggestedGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = `${group.name} ‚úì`;
            option.style.fontWeight = 'bold';
            option.style.color = '#27ae60';
            suggestedOptGroup.appendChild(option);
          });
          select.appendChild(suggestedOptGroup);
        }

        // Add all other groups
        const otherGroups = allGroups.filter(g => !suggestedGroups.some(sg => sg.id === g.id));
        if (otherGroups.length > 0) {
          const otherOptGroup = document.createElement('optgroup');
          otherOptGroup.label = 'All Groups';
          otherGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            otherOptGroup.appendChild(option);
          });
          select.appendChild(otherOptGroup);
        }
      } catch (error) {
        console.error('Failed to load groups for device:', error);
      }
    }

    async function approveDevice(deviceId) {
      const groupId = document.getElementById(`groupSelect_${deviceId}`).value;
      if (!groupId) {
        showAlert('Please select a group for the device', 'error');
        return;
      }

      try {
        const res = await fetch(`/api/devices/devices/${deviceId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupId })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert('Device approved successfully');
          loadDevices();
          loadRecentActivity();
        } else {
          showAlert(`Failed to approve device: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error approving device: ${error.message}`, 'error');
      }
    }

    async function blacklistDevice(deviceId) {
      const reason = prompt('Reason for blacklisting (optional):');
      try {
        const res = await fetch(`/api/devices/devices/${deviceId}/blacklist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert('Device blacklisted successfully');
          loadDevices();
        } else {
          showAlert(`Failed to blacklist device: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error blacklisting device: ${error.message}`, 'error');
      }
    }

    async function unblacklistDevice(deviceId) {
      try {
        const res = await fetch(`/api/devices/devices/${deviceId}/unblacklist`, { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
          showAlert('Device unblacklisted successfully');
          loadDevices();
        } else {
          showAlert(`Failed to unblacklist device: ${error.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error unblacklisting device: ${error.message}`, 'error');
      }
    }

    // Load recent activity
    async function loadRecentActivity() {
      try {
        const res = await fetch('/api/devices/connection-requests');
        const activities = await res.json();
        const container = document.getElementById('recentActivity');

        container.innerHTML = '<h3>Recent Connection Attempts</h3>';
        if (activities.length === 0) {
          container.innerHTML += '<p>No recent activity.</p>';
          return;
        }

        activities.forEach(activity => {
          const activityDiv = document.createElement('div');
          activityDiv.className = 'status-item';
          activityDiv.innerHTML = `
            <h4>Device ID: ${activity.deviceId}</h4>
            <p><strong>Action:</strong> ${activity.action}</p>
            <p><strong>Time:</strong> ${new Date(activity.timestamp).toLocaleString()}</p>
            <p><strong>Details:</strong> ${activity.details || 'N/A'}</p>
          `;
          container.appendChild(activityDiv);
        });
      } catch (error) {
        console.error('Failed to load recent activity:', error);
      }
    }

    // Load user info
    async function loadUserInfo() {
      try {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        if (data.authenticated) {
          document.getElementById('userEmail').value = data.user.email;
        }
      } catch (error) {
        console.error('Failed to load user info:', error);
      }
    }

    // Configuration handlers
    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;

      if (!currentPassword || !newPassword) {
        showAlert('Both current and new password are required', 'error');
        return;
      }

      try {
        const res = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert('Password changed successfully');
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
        } else {
          showAlert(`Failed to change password: ${data.message}`, 'error');
        }
      } catch (error) {
        showAlert(`Error changing password: ${error.message}`, 'error');
      }
    });

    // Device details functions
    async function showDeviceDetails(deviceId) {
      document.getElementById('deviceDetailId').textContent = deviceId;

      // Hide devices tab, show device details tab
      document.getElementById('devices').style.display = 'none';
      document.getElementById('deviceDetails').style.display = 'block';

      // Load device information
      await loadDeviceInfo(deviceId);
      await loadDeviceConnectionHistory(deviceId);
      await loadDeviceFirmwareHistory(deviceId);
    }

    function closeDeviceDetails() {
      document.getElementById('deviceDetails').style.display = 'none';
      document.getElementById('devices').style.display = 'block';
    }

    async function loadDeviceInfo(deviceId) {
      try {
        const res = await fetch('/api/devices/devices');
        const devices = await res.json();
        const device = devices.find(d => d.id === deviceId);

        if (device) {
          const status = device.blacklisted ? 'Blacklisted' : device.approved ? 'Approved' : 'Pending';
          const statusColor = device.blacklisted ? 'red' : device.approved ? 'green' : 'orange';

          document.getElementById('deviceInfo').innerHTML = `
            <div class="status-item">
              <h4>Device Information</h4>
              <p><strong>Device ID:</strong> ${device.id}</p>
              <p><strong>Status:</strong> <span style="color: ${statusColor}">${status}</span></p>
              <p><strong>Group:</strong> ${device.groupName || 'None'}</p>
              <p><strong>API Key Provided:</strong> ${device.providedApiKey || 'None'}</p>
              <p><strong>First Seen:</strong> ${new Date(device.firstSeen).toLocaleString()}</p>
              <p><strong>Last Seen:</strong> ${new Date(device.lastSeen).toLocaleString()}</p>
              <p><strong>Total Connections:</strong> ${device.connectionCount || 1}</p>
              ${device.blacklistReason ? `<p><strong>Blacklist Reason:</strong> ${device.blacklistReason}</p>` : ''}
              ${device.blacklistUntil ? `<p><strong>Blacklist Until:</strong> ${new Date(device.blacklistUntil).toLocaleString()}</p>` : ''}
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load device info:', error);
      }
    }

    async function loadDeviceConnectionHistory(deviceId) {
      try {
        const res = await fetch(`/api/devices/logs?deviceId=${deviceId}&limit=50`);
        const logs = await res.json();

        const container = document.getElementById('deviceConnectionHistory');
        if (logs.length === 0) {
          container.innerHTML = '<p>No connection history available.</p>';
          return;
        }

        container.innerHTML = logs.map(log => `
          <div class="status-item">
            <p><strong>${log.action}</strong> - ${new Date(log.timestamp).toLocaleString()}</p>
            <p><small>${log.details || 'No details'}</small></p>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load connection history:', error);
      }
    }

    async function loadDeviceFirmwareHistory(deviceId) {
      try {
        const res = await fetch(`/api/devices/logs?deviceId=${deviceId}&limit=100`);
        const logs = await res.json();

        const firmwareLogs = logs.filter(log =>
          log.action === 'download_start' ||
          log.action === 'download_complete' ||
          log.action === 'download_progress' ||
          log.action === 'firmware_check'
        );

        const container = document.getElementById('deviceFirmwareHistory');
        if (firmwareLogs.length === 0) {
          container.innerHTML = '<p>No firmware activity for this device.</p>';
          return;
        }

        container.innerHTML = firmwareLogs.map(log => `
          <div class="status-item">
            <p><strong>${log.action.replace('_', ' ').toUpperCase()}</strong> - ${new Date(log.timestamp).toLocaleString()}</p>
            <p><small>${log.details || 'No details'}</small></p>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load firmware history:', error);
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login.html';
      }
    });
  </script>
</body>
</html>