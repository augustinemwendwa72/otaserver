<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OTAdrive - Advanced Local OTA Server</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
    .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
    .card:hover { transform: translateY(-2px); }
    .header { text-align: center; margin-bottom: 30px; }
    h1 { margin: 0 0 8px; color: #2c3e50; font-size: 2.5em; }
    .subtitle { color: #7f8c8d; font-size: 1.1em; margin-bottom: 20px; }
    .section { margin-bottom: 30px; }
    .section h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 8px; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
    input[type="text"], input[type="password"], input[type="file"] { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; box-sizing: border-box; }
    input[type="text"]:focus, input[type="password"]:focus, input[type="file"]:focus { outline: none; border-color: #3498db; }
    .btn { display: inline-block; padding: 12px 24px; border-radius: 8px; border: none; background: #3498db; color: white; font-weight: 600; cursor: pointer; transition: background 0.3s ease; font-size: 16px; }
    .btn:hover { background: #2980b9; }
    .btn-secondary { background: #95a5a6; }
    .btn-secondary:hover { background: #7f8c8d; }
    .btn-danger { background: #e74c3c; }
    .btn-danger:hover { background: #c0392b; }
    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .status-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; }
    .status-item h3 { margin: 0 0 8px; color: #2c3e50; font-size: 1.1em; }
    .status-item p { margin: 0; color: #7f8c8d; font-family: monospace; word-break: break-all; }
    .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .config-item { background: #ecf0f1; padding: 15px; border-radius: 8px; }
    .config-item h3 { margin: 0 0 10px; color: #2c3e50; }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2196F3; }
    input:checked + .slider:before { transform: translateX(26px); }
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .loading { text-align: center; color: #7f8c8d; }
    .hidden { display: none; }
    @media (max-width: 768px) { .config-grid { grid-template-columns: 1fr; } .container { padding: 10px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card header">
      <h1>üöÄ OTAdrive</h1>
      <p class="subtitle">Advanced Local OTA Server for ESP32/Arduino Devices</p>
    </div>

    <div class="card">
      <div class="section">
        <h2>üì§ Firmware Upload</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="firmware">Firmware File (.bin)</label>
            <input type="file" id="firmware" name="firmware" accept=".bin" required>
          </div>
          <div class="form-group">
            <label for="version">Version (e.g. v1.2.3)</label>
            <input type="text" id="version" name="version" placeholder="v1.0.0" required>
          </div>
          <div class="form-group">
            <label for="api_key">API Key (for device authentication)</label>
            <input type="password" id="api_key" name="api_key" placeholder="Enter API key">
          </div>
          <button class="btn" type="submit">Upload Firmware</button>
        </form>
      </div>

      <div class="section">
        <h2>üìä Server Status</h2>
        <div id="statusContainer" class="status-grid">
          <div class="status-item">
            <h3>Status</h3>
            <p id="serverStatus">Loading...</p>
          </div>
        </div>
        <button class="btn btn-secondary" id="downloadBtn" style="margin-top: 15px;">Download Current Firmware</button>
      </div>

      <div class="section">
        <h2>‚öôÔ∏è Configuration</h2>
        <div class="config-grid">
          <div class="config-item">
            <h3>API Key</h3>
            <input type="password" id="configApiKey" placeholder="Set API key">
            <button class="btn" id="saveApiKeyBtn">Save API Key</button>
          </div>
          <div class="config-item">
            <h3>Anonymous Access</h3>
            <label class="switch">
              <input type="checkbox" id="allowAnonymous">
              <span class="slider"></span>
            </label>
            <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">Allow devices to check for updates without API key</p>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>‚ÑπÔ∏è API Information</h2>
        <div class="status-item">
          <h3>Device Check Endpoint</h3>
          <p><code>/deviceapi/check</code></p>
        </div>
        <div class="status-item">
          <h3>Firmware Download</h3>
          <p><code>/deviceapi/firmware.bin</code></p>
        </div>
        <div class="status-item">
          <h3>Manifest</h3>
          <p><code>/deviceapi/manifest.json</code></p>
        </div>
        <p style="margin-top: 15px; color: #7f8c8d; font-size: 0.9em;">Use API key in header <code>x-api-key</code> or as query parameter <code>api_key</code></p>
      </div>
    </div>
  </div>

  <script>
    let currentFirmware = null;

    async function loadStatus() {
      try {
        const r = await fetch('/api/firmware/check');
        const json = await r.json();
        currentFirmware = json;
        updateStatusDisplay(json);
      } catch (e) {
        updateStatusDisplay({ error: 'No firmware / server not ready' });
      }
    }

    function updateStatusDisplay(data) {
      const container = document.getElementById('statusContainer');
      if (data.error) {
        container.innerHTML = `
          <div class="status-item">
            <h3>Status</h3>
            <p>${data.error}</p>
          </div>
        `;
        document.getElementById('downloadBtn').classList.add('hidden');
        return;
      }

      container.innerHTML = `
        <div class="status-item">
          <h3>Version</h3>
          <p>${data.version || 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>MD5 Hash</h3>
          <p>${data.md5 || 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>File Size</h3>
          <p>${data.size ? formatBytes(data.size) : 'N/A'}</p>
        </div>
        <div class="status-item">
          <h3>Download URL</h3>
          <p>${data.url || '/deviceapi/firmware.bin'}</p>
        </div>
      `;
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      document.querySelector('.card').insertBefore(alertDiv, document.querySelector('.card').firstChild);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    // Load initial status
    loadStatus();

    // Upload form handler
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Uploading...';
      submitBtn.disabled = true;

      try {
        const res = await fetch('/api/upload', { method: 'POST', body: form });
        const data = await res.json();
        if (res.ok) {
          showAlert(`‚úÖ ${data.message}`);
          loadStatus();
          e.target.reset();
        } else {
          showAlert(`‚ùå ${data.message}`, 'error');
        }
      } catch (err) {
        showAlert(`‚ùå Upload failed: ${err.message}`, 'error');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Download button handler
    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (currentFirmware && currentFirmware.url) {
        window.open(currentFirmware.url, '_blank');
      } else {
        showAlert('No firmware available for download', 'error');
      }
    });

    // Configuration handlers
    document.getElementById('saveApiKeyBtn').addEventListener('click', async () => {
      const apiKey = document.getElementById('configApiKey').value;
      if (!apiKey) {
        showAlert('Please enter an API key', 'error');
        return;
      }

      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: apiKey })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert('API key saved successfully');
          document.getElementById('configApiKey').value = '';
        } else {
          showAlert(`Failed to save API key: ${data.message}`, 'error');
        }
      } catch (err) {
        showAlert(`Error saving API key: ${err.message}`, 'error');
      }
    });

    document.getElementById('allowAnonymous').addEventListener('change', async (e) => {
      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allow_anonymous_check: e.target.checked })
        });
        const data = await res.json();
        if (res.ok) {
          showAlert(`Anonymous access ${e.target.checked ? 'enabled' : 'disabled'}`);
        } else {
          showAlert(`Failed to update setting: ${data.message}`, 'error');
          e.target.checked = !e.target.checked; // Revert on error
        }
      } catch (err) {
        showAlert(`Error updating setting: ${err.message}`, 'error');
        e.target.checked = !e.target.checked; // Revert on error
      }
    });

    // Load current configuration
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        document.getElementById('allowAnonymous').checked = config.allow_anonymous_check || false;
      } catch (err) {
        console.error('Failed to load config:', err);
      }
    }
    loadConfig();
  </script>
</body>
</html>